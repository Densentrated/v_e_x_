name: Deploy to VPS
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy files to VPS
        run: |
          # Create server directory on VPS if it doesn't exist
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_HOST }} "mkdir -p ~/server"

          # Remove old files and copy new ones
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_HOST }} "cd ~/server && rm -rf * .*[!.] 2>/dev/null || true"

          # Copy all files except .git and .gitea directories
          tar --exclude='.git' --exclude='.gitea' -czf - . | \
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.VPS_HOST }} \
            "cd ~/server && tar -xzf -"

      - name: Build and Deploy on VPS
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ~/server

            # Setup shell environment for non-interactive shells
            echo "=== Shell Environment Debug ==="
            echo "Current shell: $0"
            echo "Original PATH: $PATH"

            export PATH="$HOME/.local/bin:$PATH"

            # Source .zshenv if it exists (zsh users)
            if [ -f "$HOME/.zshenv" ]; then
              echo "Sourcing .zshenv"
              source "$HOME/.zshenv"
            fi

            # Source .profile if it exists (fallback)
            if [ -f "$HOME/.profile" ]; then
              echo "Sourcing .profile"
              source "$HOME/.profile"
            fi

            echo "Final PATH: $PATH"
            echo "Podman location: $(which podman 2>/dev/null || echo 'not found')"
            echo "Podman-compose location: $(which podman-compose 2>/dev/null || echo 'not found')"
            echo ""

            # Detect system architecture for Go build
            echo "=== Architecture Detection ==="
            ARCH=$(uname -m)
            case $ARCH in
              x86_64)
                export TARGETARCH=amd64
                ;;
              aarch64|arm64)
                export TARGETARCH=arm64
                ;;
              armv7l)
                export TARGETARCH=arm
                ;;
              *)
                export TARGETARCH=amd64
                echo "Unknown architecture $ARCH, defaulting to amd64"
                ;;
            esac
            echo "System architecture: $ARCH"
            echo "Target Go architecture: $TARGETARCH"
            echo ""

            echo "=== Setting up production environment variables ==="

            # Export all required environment variables from secrets
            export SERVER_PORT="${{ secrets.SERVER_PORT || '22010' }}"
            export GIT_USER="${{ secrets.GIT_USER }}"
            export GIT_PAT="${{ secrets.GIT_PAT }}"
            export CLONE_FOLDER="/app/clone"
            export NOTES_REPO="${{ secrets.NOTES_REPO }}"
            export VOYAGE_API_KEY="${{ secrets.VOYAGE_API_KEY }}"
            export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
            export VECTOR_STORAGE_FOLDER="/app/vectors"
            export HARD_CODED_API_KEY="${{ secrets.HARD_CODED_API_KEY }}"

            echo "Environment variables configured for production"
            echo "SERVER_PORT: $SERVER_PORT"
            echo "GIT_USER: $GIT_USER"
            echo "CLONE_FOLDER: $CLONE_FOLDER"
            echo "VECTOR_STORAGE_FOLDER: $VECTOR_STORAGE_FOLDER"

            echo ""
            echo "=== Stopping existing containers ==="
            podman-compose -f podman-compose.prod.yml down 2>/dev/null || true

            # Clean up old containers and images
            echo "Cleaning up old images..."
            podman container prune -f || true
            podman image prune -f || true

            echo ""
            echo "=== Building and starting containers ==="
            podman-compose -f podman-compose.prod.yml up -d --build

            echo ""
            echo "=== Waiting for services to start ==="
            sleep 10

            echo ""
            echo "=== Checking deployment status ==="
            if podman-compose -f podman-compose.prod.yml ps | grep -q "Up"; then
              echo "‚úÖ Deployment successful - containers are running"
              podman-compose -f podman-compose.prod.yml ps
            else
              echo "‚ùå Deployment failed - containers not running"
              echo "Container logs:"
              podman-compose -f podman-compose.prod.yml logs vex-backend || echo "No logs available"
              exit 1
            fi

            echo ""
            echo "=== Health check ==="
            for i in {1..30}; do
              if curl -f -s "http://localhost:$SERVER_PORT/health" > /dev/null 2>&1; then
                echo "‚úÖ Health check passed - application is ready"
                echo "üöÄ Application deployed successfully at http://localhost:$SERVER_PORT"
                exit 0
              fi
              echo "Health check attempt $i/30 - waiting..."
              sleep 2
            done

            echo "‚ö†Ô∏è  Health check timeout - check application logs"
            podman-compose -f podman-compose.prod.yml logs --tail=50 vex-backend
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ~/server

            # Setup shell environment for non-interactive shells
            export PATH="$HOME/.local/bin:$PATH"

            # Source .zshenv if it exists (zsh users)
            if [ -f "$HOME/.zshenv" ]; then
              source "$HOME/.zshenv"
            fi

            # Source .profile if it exists (fallback)
            if [ -f "$HOME/.profile" ]; then
              source "$HOME/.profile"
            fi

            echo "=== Final deployment verification ==="
            echo "Container status:"
            podman-compose -f podman-compose.prod.yml ps

            echo ""
            echo "Recent application logs:"
            podman-compose -f podman-compose.prod.yml logs --tail=20 vex-backend

            echo ""
            echo "=== Deployment Summary ==="
            if podman-compose -f podman-compose.prod.yml ps | grep -q "Up"; then
              echo "‚úÖ Success - VEX application is running"
            else
              echo "‚ùå Failure - VEX application is not running"
              exit 1
            fi
          EOF
